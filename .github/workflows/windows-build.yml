name: Build Windows EXE

permissions:
  contents: write

on:
  push:
    branches: [ main, master ]
    tags: ['*']
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSYS2 and install packages
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: |
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-boost

      - name: Fetch header-only deps (better-enums)
        run: |
          git clone --depth=1 https://github.com/aantron/better-enums.git third_party/better-enums
        shell: bash

      - name: Build with mingw-w64
        shell: bash
        run: |
          set -e
          # Use MSYS2 bash to run pacman (absolute path) so pacman is found on Windows runner
          /c/msys64/usr/bin/bash -lc "pacman -Syu --noconfirm" || true
          /c/msys64/usr/bin/bash -lc "pacman -S --noconfirm --needed mingw-w64-x86_64-boost mingw-w64-x86_64-toolchain" || true

          # ensure mingw64 toolchain in PATH
          export PATH="/c/msys64/mingw64/bin:$PATH"

          # debug: show tool versions and verify boost headers exist
          g++ --version || true
          echo "windres:" $(which windres || true)
          echo "mingw include path:" /mingw64/include
          ls -la /mingw64/include/boost || true

          # build resource object (ignore failure if resource tool not present)
          windres resource.rc resource.o || true

          # compile: add explicit mingw include path so Boost headers are found
          g++ -std=c++17 -Ithird_party/better-enums -I/mingw64/include main.cpp magicwound.cpp resource.o -lws2_32 -mconsole -pthread -o MagicWound.exe

      - name: Create release bundle (exe + runtime DLLs)
        if: always()
        shell: bash
        run: |
          set -e
          mkdir -p release_bundle
          cp -v MagicWound.exe release_bundle/ || true

          # copy common MSYS2/Mingw-w64 runtime DLLs that g++-built executables may need
          patterns=( 
            libwinpthread-1.dll
            libstdc++-6.dll
            libgcc_s_seh-1.dll
            libgcc_s_dw2-1.dll
            libgcc_s_sjlj-1.dll
            libgomp-1.dll
          )

          for p in "${patterns[@]}"; do
            for f in /mingw64/bin/$p; do
              if [ -f "$f" ]; then
                echo "copying $f"
                cp -v "$f" release_bundle/ || true
              fi
            done
          done

          # Also copy any libstdc++ / libgcc_s variants just in case
          for f in /mingw64/bin/libstdc++-*.dll /mingw64/bin/libgcc_s-*.dll; do
            if [ -f "$f" ]; then cp -v "$f" release_bundle/ || true; fi
          done

          # create a zip containing the exe and DLLs
          if command -v zip >/dev/null 2>&1; then
            zip -j MagicWound.zip release_bundle/* || true
          else
            python - <<PY
import zipfile,glob,os
with zipfile.ZipFile('MagicWound.zip','w') as z:
  for fn in glob.glob('release_bundle/*'):
    z.write(fn, os.path.basename(fn))
PY
          fi

      - name: Upload release bundle
        uses: actions/upload-artifact@v4
        with:
          name: MagicWound-windows
          path: MagicWound.zip

  publish-release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-windows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built artifact
        uses: actions/download-artifact@v4
        with:
          name: MagicWound-windows
          path: ./out

      - name: Read version file
        id: read_version
        run: |
          VERSION=$(cat version | tr -d '\r\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.read_version.outputs.version }}
          release_name: Release ${{ steps.read_version.outputs.version }}
          body: Automated build (run ${{ github.run_number }}) - version ${{ steps.read_version.outputs.version }}
          draft: false
          prerelease: false

      - name: Upload release asset (zip)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./out/MagicWound.zip
          asset_name: MagicWound-${{ steps.read_version.outputs.version }}.zip
          asset_content_type: application/zip
